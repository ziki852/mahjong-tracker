<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>éº»å°†æˆ˜ç»©æœ¬</title>
<link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --felt: #1d5c35;
    --gold: #d4a843;
    --gold-light: #f0c96a;
    --cream: #faf3e0;
    --card-bg: rgba(255,255,255,0.06);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Noto Sans SC', sans-serif;
    background-color: var(--felt);
    background-image:
      radial-gradient(ellipse at 20% 20%, rgba(255,255,255,0.04) 0%, transparent 60%),
      repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.03) 10px, rgba(0,0,0,0.03) 11px);
    min-height: 100vh;
    color: var(--cream);
    padding-bottom: 60px;
  }
  header { text-align: center; padding: 32px 20px 20px; }
  header::after {
    content: '';
    display: block;
    width: 80%;
    max-width: 400px;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
    margin: 16px auto 0;
  }
  h1 {
    font-family: 'Ma Shan Zheng', cursive;
    font-size: 2.4rem;
    color: var(--gold-light);
    text-shadow: 0 2px 8px rgba(0,0,0,0.5);
    letter-spacing: 4px;
  }
  .subtitle { font-size: 0.78rem; color: rgba(240,201,106,0.65); margin-top: 6px; letter-spacing: 2px; }
  .sync-status { font-size: 0.7rem; margin-top: 6px; color: rgba(255,255,255,0.4); }
  .sync-status.syncing { color: #ffc107; }
  .sync-status.synced { color: #5de88a; }
  .sync-status.error { color: #ff6b6b; }
  .container { max-width: 480px; margin: 0 auto; padding: 0 16px; }

  /* Person tabs */
  .person-tabs {
    display: flex;
    gap: 8px;
    margin: 16px 0 4px;
    justify-content: center;
  }
  .person-tab {
    flex: 1;
    max-width: 160px;
    padding: 10px;
    border-radius: 12px;
    border: 1px solid rgba(212,168,67,0.3);
    background: transparent;
    color: rgba(240,201,106,0.6);
    cursor: pointer;
    font-family: 'Noto Sans SC', sans-serif;
    font-size: 0.85rem;
    transition: all 0.15s;
    text-align: center;
  }
  .person-tab.active {
    background: rgba(212,168,67,0.2);
    color: var(--gold-light);
    border-color: var(--gold);
  }
  .person-tab.all.active { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.4); color: white; }

  /* Summary */
  .summary { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 14px 0; }
  .stat-card {
    background: var(--card-bg);
    border: 1px solid rgba(212,168,67,0.25);
    border-radius: 14px;
    padding: 14px 12px;
    text-align: center;
  }
  .stat-label { font-size: 0.68rem; color: rgba(240,201,106,0.7); letter-spacing: 1px; margin-bottom: 6px; }
  .stat-value { font-size: 1.6rem; font-weight: 700; line-height: 1; }
  .stat-value.win { color: #5de88a; }
  .stat-value.lose { color: #ff6b6b; }
  .stat-value.neutral { color: var(--gold-light); }
  .stat-sub { font-size: 0.65rem; color: rgba(255,255,255,0.4); margin-top: 4px; }

  /* Budget sections */
  .budget-section {
    background: var(--card-bg);
    border: 1px solid rgba(212,168,67,0.25);
    border-radius: 14px;
    padding: 14px 16px;
    margin-bottom: 12px;
  }
  .budget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .budget-title { font-size: 0.73rem; color: rgba(240,201,106,0.8); letter-spacing: 1px; }
  .budget-edit { font-size: 0.68rem; cursor: pointer; border: none; background: none; color: var(--gold); text-decoration: underline; white-space: nowrap; }
  .progress-bar { background: rgba(0,0,0,0.3); border-radius: 99px; height: 8px; overflow: hidden; }
  .progress-fill { height: 100%; border-radius: 99px; transition: width 0.4s ease; background: linear-gradient(90deg, #5de88a, var(--gold-light)); }
  .progress-fill.warning { background: linear-gradient(90deg, var(--gold), #ff9f43); }
  .progress-fill.danger { background: linear-gradient(90deg, #ff9f43, #ff6b6b); }
  .budget-status { font-size: 0.7rem; margin-top: 7px; color: rgba(255,255,255,0.6); }

  /* Add form */
  .add-section {
    background: var(--card-bg);
    border: 1px solid rgba(212,168,67,0.3);
    border-radius: 16px;
    padding: 18px;
    margin-bottom: 14px;
  }
  .section-title { font-family: 'Ma Shan Zheng', cursive; font-size: 1.1rem; color: var(--gold-light); margin-bottom: 12px; letter-spacing: 2px; }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 10px;
  }
  .form-group { display: flex; flex-direction: column; gap: 5px; min-width: 0; }

  label { font-size: 0.68rem; color: rgba(240,201,106,0.7); letter-spacing: 1px; }
  input[type="date"],
  input[type="number"],
  input[type="text"] {
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(212,168,67,0.2);
    border-radius: 8px;
    color: var(--cream);
    padding: 9px 10px;
    font-size: 0.85rem;
    font-family: 'Noto Sans SC', sans-serif;
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
    min-width: 0;
  }
  input:focus { border-color: var(--gold); }
  input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); }

  .toggle-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  .toggle-btn {
    padding: 9px 6px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(0,0,0,0.2);
    color: rgba(255,255,255,0.5);
    font-size: 0.82rem;
    cursor: pointer;
    transition: all 0.15s;
    font-family: 'Noto Sans SC', sans-serif;
    text-align: center;
    white-space: nowrap;
  }
  .toggle-btn.active-win { background: rgba(93,232,138,0.2); border-color: #5de88a; color: #5de88a; }
  .toggle-btn.active-lose { background: rgba(255,107,107,0.2); border-color: #ff6b6b; color: #ff6b6b; }
  .toggle-btn.active-person { background: rgba(212,168,67,0.2); border-color: var(--gold); color: var(--gold-light); }

  .submit-btn {
    width: 100%; padding: 12px;
    background: linear-gradient(135deg, var(--gold), #b8860b);
    border: none; border-radius: 10px;
    color: #1a1a1a; font-weight: 700; font-size: 0.92rem;
    cursor: pointer; margin-top: 10px;
    font-family: 'Noto Sans SC', sans-serif;
    letter-spacing: 2px;
    transition: opacity 0.15s, transform 0.1s;
  }
  .submit-btn:active { transform: scale(0.98); opacity: 0.85; }
  .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Records */
  .records-section { margin-top: 6px; }
  .records-header { margin-bottom: 10px; }
  .records-header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .filter-tabs { display: flex; gap: 5px; flex-wrap: wrap; }
  .filter-tab {
    font-size: 0.65rem; padding: 4px 9px; border-radius: 99px;
    border: 1px solid rgba(212,168,67,0.3); background: transparent;
    color: rgba(240,201,106,0.6); cursor: pointer;
    font-family: 'Noto Sans SC', sans-serif; transition: all 0.15s;
  }
  .filter-tab.active { background: rgba(212,168,67,0.2); color: var(--gold-light); border-color: var(--gold); }

  .export-btn {
    font-size: 0.65rem; padding: 4px 10px; border-radius: 99px;
    border: 1px solid rgba(255,255,255,0.2); background: transparent;
    color: rgba(255,255,255,0.5); cursor: pointer;
    font-family: 'Noto Sans SC', sans-serif; transition: all 0.15s;
  }
  .export-btn:hover { border-color: var(--gold); color: var(--gold-light); }

  .record-item {
    background: var(--card-bg);
    border: 1px solid rgba(212,168,67,0.15);
    border-radius: 12px; padding: 12px 14px; margin-bottom: 9px;
    display: flex; align-items: center; gap: 10px;
    animation: slideIn 0.2s ease;
  }
  @keyframes slideIn { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:translateY(0); } }
  .record-icon { font-size: 1.4rem; flex-shrink: 0; }
  .record-info { flex: 1; min-width: 0; }
  .record-meta { display: flex; gap: 6px; align-items: center; margin-bottom: 2px; }
  .record-date { font-size: 0.68rem; color: rgba(255,255,255,0.4); }
  .record-person {
    font-size: 0.62rem; padding: 1px 6px; border-radius: 99px;
    background: rgba(212,168,67,0.15); color: var(--gold-light);
    border: 1px solid rgba(212,168,67,0.25);
  }
  .record-note { font-size: 0.8rem; color: rgba(255,255,255,0.75); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .record-amount { font-size: 1.1rem; font-weight: 700; flex-shrink: 0; }
  .record-amount.win { color: #5de88a; }
  .record-amount.lose { color: #ff6b6b; }
  .record-delete { background: none; border: none; color: rgba(255,255,255,0.2); font-size: 1rem; cursor: pointer; padding: 4px; transition: color 0.15s; flex-shrink: 0; }
  .record-delete:hover { color: #ff6b6b; }

  .empty-state { text-align: center; padding: 36px 20px; color: rgba(255,255,255,0.3); font-size: 0.83rem; line-height: 1.8; }
  .empty-state .icon { font-size: 2.2rem; margin-bottom: 10px; }

  /* Modal */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7);
    z-index: 100; display: flex; align-items: center; justify-content: center;
    padding: 20px; opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .modal-overlay.show { opacity: 1; pointer-events: all; }
  .modal {
    background: #1e5e36; border: 1px solid rgba(212,168,67,0.4);
    border-radius: 16px; padding: 22px; width: 100%; max-width: 320px;
    transform: scale(0.95); transition: transform 0.2s;
  }
  .modal-overlay.show .modal { transform: scale(1); }
  .modal h3 { font-family: 'Ma Shan Zheng', cursive; color: var(--gold-light); font-size: 1.1rem; margin-bottom: 12px; letter-spacing: 2px; }
  .modal p { font-size: 0.78rem; color: rgba(255,255,255,0.6); margin-bottom: 12px; line-height: 1.6; }
  .modal-row { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
  .modal-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 14px; }
  .btn-cancel { padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: rgba(255,255,255,0.7); cursor: pointer; font-family: 'Noto Sans SC', sans-serif; }
  .btn-confirm { padding: 10px; background: var(--gold); border: none; border-radius: 8px; color: #1a1a1a; font-weight: 700; cursor: pointer; font-family: 'Noto Sans SC', sans-serif; }

  .toast {
    position: fixed; bottom: 30px; left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: rgba(20,20,20,0.95);
    border: 1px solid rgba(212,168,67,0.3);
    color: var(--cream); padding: 10px 20px; border-radius: 99px;
    font-size: 0.82rem; z-index: 200; transition: transform 0.3s ease; white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<header>
  <h1>ğŸ€„ éº»å°†æˆ˜ç»©æœ¬</h1>
  <p class="subtitle">èµ¢äº†è®°ä¸€ç¬” Â· è¾“äº†ä¹Ÿå¾—è®°</p>
  <p class="sync-status" id="syncStatus">â˜ï¸ è¿æ¥ä¸­â€¦</p>
</header>

<div class="container">

  <!-- äººç‰©åˆ‡æ¢è§†è§’ -->
  <div class="person-tabs">
    <button class="person-tab all active" id="viewAll" onclick="setView('all', this)">ğŸ“Š å…¨éƒ¨</button>
    <button class="person-tab" id="viewä¸€ç²’ç±³" onclick="setView('ä¸€ç²’ç±³', this)">ğŸŒ¾ ä¸€ç²’ç±³</button>
    <button class="person-tab" id="viewè°­è€å¸ˆ" onclick="setView('è°­è€å¸ˆ', this)">ğŸ‘©â€ğŸ« è°­è€å¸ˆ</button>
  </div>

  <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
  <div class="summary">
    <div class="stat-card">
      <div class="stat-label">æœ¬æœˆå‡€æ”¶ç›Š</div>
      <div class="stat-value neutral" id="monthNet">Â¥0</div>
      <div class="stat-sub" id="monthSubtext">æš‚æ— è®°å½•</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">æœ¬æœˆåœºæ¬¡</div>
      <div class="stat-value neutral" id="monthCount">0</div>
      <div class="stat-sub" id="monthWinRate">â€”</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">æ€»å‡€æ”¶ç›Š</div>
      <div class="stat-value neutral" id="totalNet">Â¥0</div>
      <div class="stat-sub" id="totalSub">å…± 0 åœº</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">æœ€å¤§å•ç¬”</div>
      <div class="stat-value neutral" id="maxRecord">â€”</div>
      <div class="stat-sub" id="maxRecordSub">æš‚æ— </div>
    </div>
  </div>

  <!-- æœ¬å‘¨é™é¢ -->
  <div class="budget-section">
    <div class="budget-header">
      <span class="budget-title">ğŸ“… æœ¬å‘¨äºæŸé¢„è­¦</span>
      <button class="budget-edit" onclick="openBudgetModal('week')">ä¿®æ”¹ä¸Šé™</button>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="weekProgressFill" style="width:0%"></div>
    </div>
    <div class="budget-status" id="weekBudgetStatus">ç‚¹å‡»ã€Œä¿®æ”¹ä¸Šé™ã€è®¾ç½®æ¯å‘¨æœ€å¤§äºæŸ ğŸ‘†</div>
  </div>

  <!-- æœ¬æœˆé™é¢ -->
  <div class="budget-section">
    <div class="budget-header">
      <span class="budget-title">ğŸ“† æœ¬æœˆäºæŸé¢„è­¦</span>
      <button class="budget-edit" onclick="openBudgetModal('month')">ä¿®æ”¹ä¸Šé™</button>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="monthProgressFill" style="width:0%"></div>
    </div>
    <div class="budget-status" id="monthBudgetStatus">ç‚¹å‡»ã€Œä¿®æ”¹ä¸Šé™ã€è®¾ç½®æ¯æœˆæœ€å¤§äºæŸ ğŸ‘†</div>
  </div>

  <!-- è®°ä¸€å±€ -->
  <div class="add-section">
    <div class="section-title">âœï¸ è®°ä¸€å±€</div>
    <div class="form-row">
      <div class="form-group">
        <label>æ—¥æœŸ</label>
        <input type="date" id="inputDate">
      </div>
      <div class="form-group">
        <label>é‡‘é¢ï¼ˆå…ƒï¼‰</label>
        <input type="number" id="inputAmount" placeholder="0" min="0">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>è°æ‰“çš„</label>
        <div class="toggle-group">
          <button class="toggle-btn active-person" id="btnä¸€ç²’ç±³" onclick="selectPerson('ä¸€ç²’ç±³')">ğŸŒ¾ ä¸€ç²’ç±³</button>
          <button class="toggle-btn" id="btnè°­è€å¸ˆ" onclick="selectPerson('è°­è€å¸ˆ')">ğŸ‘©â€ğŸ« è°­è€å¸ˆ</button>
        </div>
      </div>
      <div class="form-group">
        <label>è¾“èµ¢</label>
        <div class="toggle-group">
          <button class="toggle-btn active-win" id="btnWin" onclick="selectOutcome('win')">ğŸ† èµ¢</button>
          <button class="toggle-btn" id="btnLose" onclick="selectOutcome('lose')">ğŸ’¸ è¾“</button>
        </div>
      </div>
    </div>
    <div class="form-group">
      <label>å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</label>
      <input type="text" id="inputNote" placeholder="æ¯”å¦‚ï¼šèƒ¡äº†ä¸ªå¤§å››å–œ">
    </div>
    <button class="submit-btn" id="submitBtn" onclick="addRecord()">è®°ä¸‹è¿™ä¸€å±€ ğŸ‘Š</button>
  </div>

  <!-- å†å²è®°å½• -->
  <div class="records-section">
    <div class="records-header">
      <div class="records-header-top">
        <div class="section-title" style="margin:0">ğŸ“‹ å†å²è®°å½•</div>
        <button class="export-btn" onclick="exportCSV()">â¬‡ï¸ å¯¼å‡ºCSV</button>
      </div>
      <div class="filter-tabs">
        <button class="filter-tab active" onclick="setFilter('all', this)">å…¨éƒ¨</button>
        <button class="filter-tab" onclick="setFilter('win', this)">èµ¢</button>
        <button class="filter-tab" onclick="setFilter('lose', this)">è¾“</button>
        <button class="filter-tab" onclick="setFilter('ä¸€ç²’ç±³', this)">ä¸€ç²’ç±³</button>
        <button class="filter-tab" onclick="setFilter('è°­è€å¸ˆ', this)">è°­è€å¸ˆ</button>
      </div>
    </div>
    <div id="recordsList"><div class="empty-state"><div class="icon">â˜ï¸</div><div>åŠ è½½ä¸­â€¦</div></div></div>
  </div>
</div>

<!-- é™é¢å¼¹çª— -->
<div class="modal-overlay" id="budgetModal">
  <div class="modal">
    <h3 id="budgetModalTitle">âš ï¸ è®¾ç½®äºæŸä¸Šé™</h3>
    <p id="budgetModalDesc">æ¯å‘¨äºæŸè¶…è¿‡è¿™ä¸ªæ•°ï¼Œå°±ä¼šå‡ºç°çº¢è‰²è­¦å‘Š</p>
    <div class="modal-row">
      <label>æœ€å¤§äºæŸé‡‘é¢ï¼ˆå…ƒï¼‰</label>
      <input type="number" id="budgetInput" placeholder="ä¾‹å¦‚ï¼š200" min="0">
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeBudgetModal()">å–æ¶ˆ</button>
      <button class="btn-confirm" onclick="saveBudget()">ä¿å­˜</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, deleteDoc, doc,
    onSnapshot, query, orderBy, setDoc, getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyAjwQwBHsN_S8GQf_y_uYHGXj0d0yCWAU0",
    authDomain: "mahjong-tracker-80924.firebaseapp.com",
    projectId: "mahjong-tracker-80924",
    storageBucket: "mahjong-tracker-80924.firebasestorage.app",
    messagingSenderId: "710827165889",
    appId: "1:710827165889:web:d9e953e8dfb5d57ead6c40"
  });

  const db = getFirestore(app);
  let records = [];
  let weekBudget = 0, monthBudget = 0;
  let currentOutcome = 'win';
  let currentPerson = 'ä¸€ç²’ç±³';
  let currentFilter = 'all';
  let currentView = 'all'; // é¡¶éƒ¨è§†è§’åˆ‡æ¢
  let editingBudgetType = 'week';

  document.getElementById('inputDate').value = new Date().toISOString().slice(0,10);

  const syncEl = document.getElementById('syncStatus');

  async function loadBudgets() {
    try {
      const ws = await getDoc(doc(db, 'settings', 'weekBudget'));
      if (ws.exists()) weekBudget = ws.data().value || 0;
      const ms = await getDoc(doc(db, 'settings', 'monthBudget'));
      if (ms.exists()) monthBudget = ms.data().value || 0;
    } catch(e) {}
  }

  onSnapshot(
    query(collection(db, 'records'), orderBy('createdAt', 'desc')),
    (snapshot) => {
      records = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      syncEl.textContent = 'â˜ï¸ å·²åŒæ­¥';
      syncEl.className = 'sync-status synced';
      renderAll();
    },
    () => {
      syncEl.textContent = 'âš ï¸ åŒæ­¥å¤±è´¥ï¼Œæ£€æŸ¥ç½‘ç»œ';
      syncEl.className = 'sync-status error';
    }
  );

  loadBudgets().then(renderAll);

  // å·¥å…·å‡½æ•°
  function getWeekRange() {
    const now = new Date();
    const day = now.getDay() || 7;
    const mon = new Date(now); mon.setDate(now.getDate() - day + 1); mon.setHours(0,0,0,0);
    const sun = new Date(mon); sun.setDate(mon.getDate() + 6); sun.setHours(23,59,59,999);
    return { start: mon, end: sun };
  }

  function dateInWeek(dateStr) {
    const { start, end } = getWeekRange();
    const d = new Date(dateStr);
    return d >= start && d <= end;
  }

  function getMonthPrefix() {
    const now = new Date();
    return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  }

  function filterByView(recs) {
    if (currentView === 'all') return recs;
    return recs.filter(r => r.person === currentView);
  }

  // â€”â€”â€” æ¸²æŸ“ â€”â€”â€”
  function renderAll() { renderStats(); renderBudgets(); renderRecords(); }

  function renderStats() {
    const viewRecs = filterByView(records);
    const m = getMonthPrefix();
    const mr = viewRecs.filter(r => r.date?.startsWith(m));
    const monthNet = mr.reduce((s,r) => s + (r.outcome==='win' ? r.amount : -r.amount), 0);
    const totalNet = viewRecs.reduce((s,r) => s + (r.outcome==='win' ? r.amount : -r.amount), 0);
    const mWins = mr.filter(r => r.outcome==='win').length;

    const mnEl = document.getElementById('monthNet');
    mnEl.textContent = (monthNet>=0?'+':'') + 'Â¥' + Math.abs(monthNet);
    mnEl.className = 'stat-value ' + (monthNet>0?'win':monthNet<0?'lose':'neutral');
    document.getElementById('monthSubtext').textContent = monthNet>0?'å°èµšä¸€ç¬” ğŸ˜„':monthNet<0?'äºäº†ï¼ŒåŠ æ²¹ ğŸ’ª':'ä¸è¾“ä¸èµ¢';
    document.getElementById('monthCount').textContent = mr.length;
    document.getElementById('monthWinRate').textContent = mr.length ? `èƒœç‡ ${Math.round(mWins/mr.length*100)}%` : 'å¼€å§‹è®°å½•å§';

    const tnEl = document.getElementById('totalNet');
    tnEl.textContent = (totalNet>=0?'+':'') + 'Â¥' + Math.abs(totalNet);
    tnEl.className = 'stat-value ' + (totalNet>0?'win':totalNet<0?'lose':'neutral');
    document.getElementById('totalSub').textContent = `å…± ${viewRecs.length} åœº`;

    if (viewRecs.length) {
      const wins = viewRecs.filter(r=>r.outcome==='win');
      const loses = viewRecs.filter(r=>r.outcome==='lose');
      const mxW = wins.length ? Math.max(...wins.map(r=>r.amount)) : 0;
      const mxL = loses.length ? Math.max(...loses.map(r=>r.amount)) : 0;
      const isBigWin = mxW >= mxL;
      const maxEl = document.getElementById('maxRecord');
      maxEl.textContent = (isBigWin?'+':'-') + 'Â¥' + (isBigWin?mxW:mxL);
      maxEl.className = 'stat-value ' + (isBigWin?'win':'lose');
      document.getElementById('maxRecordSub').textContent = isBigWin ? 'æœ€å¤§å•èµ¢' : 'æœ€å¤§å•è¾“';
    } else {
      document.getElementById('maxRecord').textContent = 'â€”';
      document.getElementById('maxRecordSub').textContent = 'æš‚æ— ';
    }
  }

  function renderBudgets() {
    const viewRecs = filterByView(records);
    const m = getMonthPrefix();

    const weekLoss = viewRecs.filter(r => dateInWeek(r.date) && r.outcome==='lose').reduce((s,r)=>s+r.amount,0);
    const monthLoss = viewRecs.filter(r => r.date?.startsWith(m) && r.outcome==='lose').reduce((s,r)=>s+r.amount,0);

    renderBudgetBar('week', weekBudget, weekLoss, 'weekProgressFill', 'weekBudgetStatus', 'æœ¬å‘¨');
    renderBudgetBar('month', monthBudget, monthLoss, 'monthProgressFill', 'monthBudgetStatus', 'æœ¬æœˆ');
  }

  function renderBudgetBar(type, budget, loss, fillId, statusId, label) {
    const fill = document.getElementById(fillId);
    const status = document.getElementById(statusId);
    if (!budget) {
      fill.style.width = '0%';
      status.textContent = `ç‚¹å‡»ã€Œä¿®æ”¹ä¸Šé™ã€è®¾ç½®${label}æœ€å¤§äºæŸ ğŸ‘†`;
      status.style.color = 'rgba(255,255,255,0.6)';
      return;
    }
    const pct = Math.min(loss/budget*100, 100);
    fill.style.width = pct + '%';
    fill.className = 'progress-fill' + (pct>=100?' danger':pct>=70?' warning':'');
    if (pct>=100) { status.innerHTML = `ğŸš¨ ${label}å·²äº Â¥${loss}ï¼Œè¶…è¿‡ä¸Šé™ Â¥${budget}ï¼æ”¶æ‰‹å§ï¼`; status.style.color='#ff6b6b'; }
    else if (pct>=70) { status.innerHTML = `âš ï¸ ${label}å·²äº Â¥${loss} / Â¥${budget}ï¼ˆ${Math.round(pct)}%ï¼‰ï¼Œæ‚ ç€ç‚¹`; status.style.color='#ffc107'; }
    else { status.innerHTML = `âœ… ${label}äºæŸ Â¥${loss} / Â¥${budget}ï¼ˆ${Math.round(pct)}%ï¼‰ï¼Œè¿˜å¥½è¿˜å¥½`; status.style.color='rgba(255,255,255,0.6)'; }
  }

  function renderRecords() {
    const list = document.getElementById('recordsList');
    let filtered = filterByView(records);
    if (currentFilter === 'win') filtered = filtered.filter(r=>r.outcome==='win');
    else if (currentFilter === 'lose') filtered = filtered.filter(r=>r.outcome==='lose');
    else if (currentFilter === 'ä¸€ç²’ç±³') filtered = filtered.filter(r=>r.person==='ä¸€ç²’ç±³');
    else if (currentFilter === 'è°­è€å¸ˆ') filtered = filtered.filter(r=>r.person==='è°­è€å¸ˆ');

    if (!filtered.length) {
      list.innerHTML = `<div class="empty-state"><div class="icon">ğŸ€„</div><div>è¿˜æ²¡æœ‰è®°å½•ï¼Œå¿«å»æ‰“ä¸€å±€ï¼</div></div>`;
      return;
    }
    list.innerHTML = filtered.map(r => {
      const isWin = r.outcome==='win';
      const ds = r.date ? r.date.slice(5).replace('-','/') : '';
      const personIcon = r.person === 'ä¸€ç²’ç±³' ? 'ğŸŒ¾' : 'ğŸ‘©â€ğŸ«';
      return `<div class="record-item">
        <div class="record-icon">${isWin?'ğŸ†':'ğŸ’¸'}</div>
        <div class="record-info">
          <div class="record-meta">
            <span class="record-date">${r.date?.slice(0,4)||''}/${ds}</span>
            <span class="record-person">${personIcon} ${r.person||'æœªçŸ¥'}</span>
          </div>
          <div class="record-note">${esc(r.note||'')}</div>
        </div>
        <div class="record-amount ${isWin?'win':'lose'}">${isWin?'+':'-'}Â¥${r.amount}</div>
        <button class="record-delete" onclick="deleteRecord('${r.id}')">âœ•</button>
      </div>`;
    }).join('');
  }

  // â€”â€”â€” å…¨å±€å‡½æ•° â€”â€”â€”
  window.setView = (view, el) => {
    currentView = view;
    document.querySelectorAll('.person-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    renderAll();
  };

  window.selectPerson = (person) => {
    currentPerson = person;
    document.getElementById('btnä¸€ç²’ç±³').className = 'toggle-btn' + (person==='ä¸€ç²’ç±³'?' active-person':'');
    document.getElementById('btnè°­è€å¸ˆ').className = 'toggle-btn' + (person==='è°­è€å¸ˆ'?' active-person':'');
  };

  window.selectOutcome = (type) => {
    currentOutcome = type;
    document.getElementById('btnWin').className = 'toggle-btn' + (type==='win'?' active-win':'');
    document.getElementById('btnLose').className = 'toggle-btn' + (type==='lose'?' active-lose':'');
  };

  window.addRecord = async () => {
    const date = document.getElementById('inputDate').value;
    const amount = parseFloat(document.getElementById('inputAmount').value);
    const note = document.getElementById('inputNote').value.trim();
    if (!date) { showToast('ğŸ“… æ—¥æœŸä¸èƒ½ä¸ºç©ºå“¦'); return; }
    if (!amount || amount <= 0) { showToast('ğŸ’° é‡‘é¢å¾—å¡«ä¸ªæ­£æ•°å§'); return; }

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    syncEl.textContent = 'â˜ï¸ ä¿å­˜ä¸­â€¦'; syncEl.className = 'sync-status syncing';

    try {
      await addDoc(collection(db, 'records'), {
        date, amount, outcome: currentOutcome, person: currentPerson,
        note: note || (currentOutcome==='win' ? `${currentPerson}åˆèµ¢äº†ï¼` : `${currentPerson}ä»Šå¤©æ‰‹æ°”ä¸å¥½â€¦`),
        createdAt: Date.now()
      });
      document.getElementById('inputAmount').value = '';
      document.getElementById('inputNote').value = '';
      const msgs = currentOutcome==='win'
        ? ['è®°ä¸‹äº†ï¼è´¢ç¥çˆ·ä¿ä½‘ ğŸ‰','èµ¢äº†èµ¢äº†ï¼è®°å¥½è´¦ âœ…','äººæŒ¡æ€äººï¼Œç‰ŒæŒ¡æ€ç‰Œ ğŸ€„']
        : ['å“ï¼Œè®°ä¸‹äº†â€¦ä¸‹æŠŠæ‰³å›æ¥ ğŸ™','äºäº†ä¹Ÿæ˜¯å†ç»ƒï¼Œè®°å¥½è´¦ ğŸ“','åˆ«ç°å¿ƒï¼Œä¸œé£è¿˜æ²¡æ¥å‘¢ ğŸ’ª'];
      showToast(msgs[Math.floor(Math.random()*msgs.length)]);
    } catch(e) { showToast('âŒ ä¿å­˜å¤±è´¥ï¼Œæ£€æŸ¥ç½‘ç»œ'); }
    btn.disabled = false;
  };

  window.deleteRecord = async (id) => {
    if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ')) return;
    try { await deleteDoc(doc(db, 'records', id)); showToast('ğŸ—‘ï¸ å·²åˆ é™¤'); }
    catch(e) { showToast('âŒ åˆ é™¤å¤±è´¥'); }
  };

  window.setFilter = (filter, el) => {
    currentFilter = filter;
    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    renderRecords();
  };

  window.openBudgetModal = (type) => {
    editingBudgetType = type;
    const isWeek = type === 'week';
    document.getElementById('budgetModalTitle').textContent = isWeek ? 'âš ï¸ è®¾ç½®æ¯å‘¨äºæŸä¸Šé™' : 'âš ï¸ è®¾ç½®æ¯æœˆäºæŸä¸Šé™';
    document.getElementById('budgetModalDesc').textContent = isWeek
      ? 'æœ¬å‘¨äºæŸè¶…è¿‡è¿™ä¸ªæ•°ï¼Œå°±ä¼šå‡ºç°çº¢è‰²è­¦å‘Šï¼Œæé†’æ”¶æ‰‹'
      : 'æœ¬æœˆäºæŸè¶…è¿‡è¿™ä¸ªæ•°ï¼Œå°±ä¼šå‡ºç°çº¢è‰²è­¦å‘Šï¼Œæé†’æ”¶æ‰‹';
    document.getElementById('budgetInput').value = isWeek ? (weekBudget||'') : (monthBudget||'');
    document.getElementById('budgetModal').classList.add('show');
  };

  window.closeBudgetModal = () => document.getElementById('budgetModal').classList.remove('show');

  window.saveBudget = async () => {
    const val = parseInt(document.getElementById('budgetInput').value);
    if (!val || val <= 0) { showToast('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢'); return; }
    try {
      const key = editingBudgetType === 'week' ? 'weekBudget' : 'monthBudget';
      await setDoc(doc(db, 'settings', key), { value: val });
      if (editingBudgetType === 'week') weekBudget = val;
      else monthBudget = val;
      closeBudgetModal();
      renderBudgets();
      showToast(`âœ… ${editingBudgetType==='week'?'å‘¨':'æœˆ'}ä¸Šé™è®¾ç½®ä¸º Â¥${val}`);
    } catch(e) { showToast('âŒ ä¿å­˜å¤±è´¥'); }
  };

  window.exportCSV = () => {
    if (!records.length) { showToast('è¿˜æ²¡æœ‰è®°å½•å¯ä»¥å¯¼å‡º'); return; }
    const header = 'æ—¥æœŸ,è®°å½•äºº,è¾“èµ¢,é‡‘é¢(å…ƒ),å¤‡æ³¨';
    const rows = records.map(r =>
      `${r.date},${r.person||''},${r.outcome==='win'?'èµ¢':'è¾“'},${r.amount},"${(r.note||'').replace(/"/g,'""')}"`
    );
    const csv = '\uFEFF' + [header, ...rows].join('\n'); // BOM for Excel
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `éº»å°†æˆ˜ç»©_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('ğŸ“¥ å¯¼å‡ºæˆåŠŸï¼');
  };

  document.getElementById('budgetModal').addEventListener('click', function(e) {
    if (e.target === this) closeBudgetModal();
  });

  function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2500);
  }
</script>
</body>
</html>
