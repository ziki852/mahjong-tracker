<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é©¬å¹´éº»å°†æˆ˜ç»©æœ¬</title>
<link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --felt: #1d5c35;
    --gold: #d4a843;
    --gold-light: #f0c96a;
    --cream: #faf3e0;
    --card-bg: rgba(255,255,255,0.06);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Noto Sans SC', sans-serif;
    background-color: var(--felt);
    background-image:
      radial-gradient(ellipse at 20% 20%, rgba(255,255,255,0.04) 0%, transparent 60%),
      repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.03) 10px, rgba(0,0,0,0.03) 11px);
    min-height: 100vh;
    color: var(--cream);
    padding-bottom: 60px;
  }

  header {
    text-align: center;
    padding: 32px 20px 20px;
  }

  header::after {
    content: '';
    display: block;
    width: 80%;
    max-width: 400px;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
    margin: 16px auto 0;
  }

  h1 {
    font-family: 'Ma Shan Zheng', cursive;
    font-size: 2.2rem;
    color: var(--gold-light);
    text-shadow: 0 2px 8px rgba(0,0,0,0.5);
    letter-spacing: 4px;
  }

  .subtitle {
    font-size: 0.78rem;
    color: rgba(240,201,106,0.65);
    margin-top: 6px;
    letter-spacing: 2px;
  }

  .container { max-width: 480px; margin: 0 auto; padding: 0 16px; }

  /* Player view tabs */
  .player-tabs { display: flex; gap: 8px; margin: 18px 0 14px; }

  .player-tab {
    flex: 1;
    padding: 10px 6px;
    border-radius: 12px;
    border: 1px solid rgba(212,168,67,0.3);
    background: transparent;
    color: rgba(240,201,106,0.55);
    font-size: 0.82rem;
    cursor: pointer;
    font-family: 'Noto Sans SC', sans-serif;
    transition: all 0.15s;
    text-align: center;
  }

  .player-tab.active {
    background: rgba(212,168,67,0.18);
    color: var(--gold-light);
    border-color: var(--gold);
    font-weight: 700;
  }

  /* Stats */
  .summary { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }

  .stat-card {
    background: var(--card-bg);
    border: 1px solid rgba(212,168,67,0.25);
    border-radius: 14px;
    padding: 14px;
    text-align: center;
  }

  .stat-label { font-size: 0.68rem; color: rgba(240,201,106,0.7); letter-spacing: 1.5px; margin-bottom: 6px; }
  .stat-value { font-size: 1.65rem; font-weight: 700; line-height: 1; }
  .stat-value.win { color: #5de88a; }
  .stat-value.lose { color: #ff6b6b; }
  .stat-value.neutral { color: var(--gold-light); }
  .stat-sub { font-size: 0.66rem; color: rgba(255,255,255,0.4); margin-top: 4px; }

  /* Budget */
  .budget-section {
    background: var(--card-bg);
    border: 1px solid rgba(212,168,67,0.25);
    border-radius: 14px;
    padding: 15px 16px;
    margin-bottom: 12px;
  }

  .budget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .budget-title { font-size: 0.75rem; color: rgba(240,201,106,0.85); letter-spacing: 1px; }
  .budget-edit {
    font-size: 0.68rem; color: var(--gold); text-decoration: underline;
    cursor: pointer; border: none; background: none; font-family: 'Noto Sans SC', sans-serif;
  }

  .progress-bar { background: rgba(0,0,0,0.3); border-radius: 99px; height: 9px; overflow: hidden; }
  .progress-fill { height: 100%; border-radius: 99px; transition: width 0.4s ease; background: linear-gradient(90deg, #5de88a, var(--gold-light)); }
  .progress-fill.warning { background: linear-gradient(90deg, var(--gold), #ff9f43); }
  .progress-fill.danger { background: linear-gradient(90deg, #ff9f43, #ff6b6b); }
  .budget-status { font-size: 0.7rem; margin-top: 7px; color: rgba(255,255,255,0.55); line-height: 1.5; }

  /* Form */
  .add-section {
    background: var(--card-bg);
    border: 1px solid rgba(212,168,67,0.3);
    border-radius: 16px;
    padding: 18px;
    margin-bottom: 14px;
  }

  .section-title {
    font-family: 'Ma Shan Zheng', cursive;
    font-size: 1.1rem;
    color: var(--gold-light);
    margin-bottom: 14px;
    letter-spacing: 2px;
  }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
  .form-group { display: flex; flex-direction: column; gap: 5px; }

  label { font-size: 0.68rem; color: rgba(240,201,106,0.7); letter-spacing: 1px; }

  input, select {
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(212,168,67,0.2);
    border-radius: 8px;
    color: var(--cream);
    padding: 9px 12px;
    font-size: 0.88rem;
    font-family: 'Noto Sans SC', sans-serif;
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
  }

  input:focus, select:focus { border-color: var(--gold); }
  select option { background: #1d5c35; }

  .toggle-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

  .toggle-btn {
    padding: 9px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(0,0,0,0.2);
    color: rgba(255,255,255,0.5);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.15s;
    font-family: 'Noto Sans SC', sans-serif;
  }

  .toggle-btn.active-dad  { background: rgba(100,180,255,0.2); border-color: #64b4ff; color: #64b4ff; }
  .toggle-btn.active-mom  { background: rgba(255,150,200,0.2); border-color: #ff96c8; color: #ff96c8; }
  .toggle-btn.active-win  { background: rgba(93,232,138,0.2);  border-color: #5de88a; color: #5de88a; }
  .toggle-btn.active-lose { background: rgba(255,107,107,0.2); border-color: #ff6b6b; color: #ff6b6b; }

  .submit-btn {
    width: 100%; padding: 13px;
    background: linear-gradient(135deg, var(--gold), #b8860b);
    border: none; border-radius: 10px;
    color: #1a1a1a; font-weight: 700; font-size: 0.95rem;
    cursor: pointer; margin-top: 12px;
    font-family: 'Noto Sans SC', sans-serif;
    letter-spacing: 2px;
    transition: opacity 0.15s, transform 0.1s;
  }
  .submit-btn:active { transform: scale(0.98); opacity: 0.85; }

  /* Records */
  .records-section { margin-top: 6px; }

  .records-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 12px; flex-wrap: wrap; gap: 8px;
  }

  .filter-tabs { display: flex; gap: 6px; flex-wrap: wrap; }

  .filter-tab {
    font-size: 0.68rem; padding: 4px 10px; border-radius: 99px;
    border: 1px solid rgba(212,168,67,0.3); background: transparent;
    color: rgba(240,201,106,0.6); cursor: pointer;
    font-family: 'Noto Sans SC', sans-serif; transition: all 0.15s;
  }
  .filter-tab.active { background: rgba(212,168,67,0.2); color: var(--gold-light); border-color: var(--gold); }

  .record-item {
    background: var(--card-bg);
    border: 1px solid rgba(212,168,67,0.15);
    border-radius: 12px;
    padding: 12px 14px;
    margin-bottom: 10px;
    display: flex; align-items: center; gap: 11px;
    animation: slideIn 0.2s ease;
  }

  @keyframes slideIn { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }

  .record-icon { font-size: 1.5rem; flex-shrink: 0; }
  .record-info { flex: 1; min-width: 0; }
  .record-meta { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
  .record-date { font-size: 0.68rem; color: rgba(255,255,255,0.4); }

  .player-tag {
    font-size: 0.62rem; padding: 1px 7px; border-radius: 99px;
    font-weight: 700; letter-spacing: 0.5px;
  }
  .tag-dad { background: rgba(100,180,255,0.2); color: #64b4ff; border: 1px solid rgba(100,180,255,0.4); }
  .tag-mom { background: rgba(255,150,200,0.2); color: #ff96c8; border: 1px solid rgba(255,150,200,0.4); }

  .record-note { font-size: 0.82rem; color: rgba(255,255,255,0.75); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .record-amount { font-size: 1.15rem; font-weight: 700; flex-shrink: 0; }
  .record-amount.win { color: #5de88a; }
  .record-amount.lose { color: #ff6b6b; }
  .record-delete { background: none; border: none; color: rgba(255,255,255,0.2); font-size: 1rem; cursor: pointer; padding: 4px; transition: color 0.15s; }
  .record-delete:hover { color: #ff6b6b; }

  .empty-state { text-align: center; padding: 36px 20px; color: rgba(255,255,255,0.3); font-size: 0.85rem; line-height: 1.9; }
  .empty-state .icon { font-size: 2.4rem; margin-bottom: 10px; }

  /* Modal */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.75);
    z-index: 100; display: flex; align-items: center; justify-content: center;
    padding: 20px; opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .modal-overlay.show { opacity: 1; pointer-events: all; }

  .modal {
    background: #1e5e36; border: 1px solid rgba(212,168,67,0.4);
    border-radius: 16px; padding: 22px; width: 100%; max-width: 340px;
    transform: scale(0.95); transition: transform 0.2s;
  }
  .modal-overlay.show .modal { transform: scale(1); }

  .modal h3 { font-family: 'Ma Shan Zheng', cursive; color: var(--gold-light); font-size: 1.15rem; margin-bottom: 6px; letter-spacing: 2px; }
  .modal p { font-size: 0.78rem; color: rgba(255,255,255,0.55); margin-bottom: 14px; line-height: 1.6; }

  .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }

  .modal-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 16px; }
  .btn-cancel {
    padding: 10px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15);
    border-radius: 8px; color: rgba(255,255,255,0.65); cursor: pointer;
    font-family: 'Noto Sans SC', sans-serif; font-size: 0.88rem;
  }
  .btn-confirm {
    padding: 10px; background: var(--gold); border: none;
    border-radius: 8px; color: #1a1a1a; font-weight: 700;
    cursor: pointer; font-family: 'Noto Sans SC', sans-serif; font-size: 0.88rem;
  }

  /* Toast */
  .toast {
    position: fixed; bottom: 28px; left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: rgba(15,15,15,0.95); border: 1px solid rgba(212,168,67,0.35);
    color: var(--cream); padding: 10px 20px; border-radius: 99px;
    font-size: 0.82rem; z-index: 200; transition: transform 0.3s ease; white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-thumb { background: rgba(212,168,67,0.3); border-radius: 2px; }
</style>
</head>
<body>

<header>
  <h1>ğŸ€„ é©¬å¹´éº»å°†æˆ˜ç»©æœ¬</h1>
  <p class="subtitle">ä¸€ç²’ç±³ Â· è°­è€å¸ˆ Â· èµ¢äº†è®° Â· è¾“äº†ä¹Ÿè®°</p>
</header>

<div class="container">

  <!-- äººç‰©è§†å›¾åˆ‡æ¢ -->
  <div class="player-tabs">
    <button class="player-tab active" onclick="setViewPlayer('all', this)">ğŸ‘€ å…¨å®¶æ€»è§ˆ</button>
    <button class="player-tab" onclick="setViewPlayer('dad', this)">ğŸš ä¸€ç²’ç±³</button>
    <button class="player-tab" onclick="setViewPlayer('mom', this)">ğŸ‘©â€ğŸ« è°­è€å¸ˆ</button>
  </div>

  <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
  <div class="summary">
    <div class="stat-card">
      <div class="stat-label" id="labelMonthNet">æœ¬æœˆå‡€æ”¶ç›Š</div>
      <div class="stat-value neutral" id="monthNet">Â¥0</div>
      <div class="stat-sub" id="monthSub">æš‚æ— è®°å½•</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">æœ¬æœˆåœºæ¬¡</div>
      <div class="stat-value neutral" id="monthCount">0</div>
      <div class="stat-sub" id="monthWinRate">â€”</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">æ€»å‡€æ”¶ç›Š</div>
      <div class="stat-value neutral" id="totalNet">Â¥0</div>
      <div class="stat-sub" id="totalSub">å…± 0 åœº</div>
    </div>
    <div class="stat-card">
      <div class="stat-label" id="labelWeekNet">æœ¬å‘¨å‡€æ”¶ç›Š</div>
      <div class="stat-value neutral" id="weekNet">Â¥0</div>
      <div class="stat-sub" id="weekSub">æœ¬å‘¨ 0 åœº</div>
    </div>
  </div>

  <!-- æ¯æœˆäºæŸé¢„è­¦ -->
  <div class="budget-section">
    <div class="budget-header">
      <span class="budget-title">ğŸ“… æœ¬æœˆäºæŸé¢„è­¦</span>
      <button class="budget-edit" onclick="openBudgetModal('month')">ä¿®æ”¹ä¸Šé™</button>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="monthFill" style="width:0%"></div></div>
    <div class="budget-status" id="monthStatus">ç‚¹ã€Œä¿®æ”¹ä¸Šé™ã€è®¾ç½®æ¯æœˆæœ€å¤§äºæŸé¢„ç®— ğŸ™</div>
  </div>

  <!-- æ¯å‘¨äºæŸé¢„è­¦ -->
  <div class="budget-section">
    <div class="budget-header">
      <span class="budget-title">ğŸ—“ï¸ æœ¬å‘¨äºæŸé¢„è­¦</span>
      <button class="budget-edit" onclick="openBudgetModal('week')">ä¿®æ”¹ä¸Šé™</button>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="weekFill" style="width:0%"></div></div>
    <div class="budget-status" id="weekStatus">ç‚¹ã€Œä¿®æ”¹ä¸Šé™ã€è®¾ç½®æ¯å‘¨æœ€å¤§äºæŸé¢„ç®— ğŸ™</div>
  </div>

  <!-- è®°ä¸€å±€ -->
  <div class="add-section">
    <div class="section-title">âœï¸ è®°ä¸€å±€</div>
    <div class="form-row">
      <div class="form-group">
        <label>æ—¥æœŸ</label>
        <input type="date" id="inputDate">
      </div>
      <div class="form-group">
        <label>é‡‘é¢ï¼ˆå…ƒï¼‰</label>
        <input type="number" id="inputAmount" placeholder="0" min="0">
      </div>
    </div>
    <div class="form-group" style="margin-bottom:10px">
      <label>è°æ‰“çš„</label>
      <div class="toggle-row">
        <button class="toggle-btn active-dad" id="btnDad" onclick="selectPlayer('dad')">ğŸš ä¸€ç²’ç±³</button>
        <button class="toggle-btn" id="btnMom" onclick="selectPlayer('mom')">ğŸ‘©â€ğŸ« è°­è€å¸ˆ</button>
      </div>
    </div>
    <div class="form-group" style="margin-bottom:10px">
      <label>è¾“èµ¢</label>
      <div class="toggle-row">
        <button class="toggle-btn active-win" id="btnWin" onclick="selectOutcome('win')">ğŸ† èµ¢äº†ï¼</button>
        <button class="toggle-btn" id="btnLose" onclick="selectOutcome('lose')">ğŸ’¸ è¾“äº†â€¦</button>
      </div>
    </div>
    <div class="form-group">
      <label>å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</label>
      <input type="text" id="inputNote" placeholder="æ¯”å¦‚ï¼šèƒ¡äº†ä¸ªå¤§å››å–œ">
    </div>
    <button class="submit-btn" onclick="addRecord()">è®°ä¸‹è¿™ä¸€å±€ ğŸ‘Š</button>
  </div>

  <!-- å†å²è®°å½• -->
  <div class="records-section">
    <div class="records-header">
      <div class="section-title" style="margin:0">ğŸ“‹ å†å²è®°å½•</div>
      <div class="filter-tabs">
        <button class="filter-tab active" onclick="setOutcomeFilter('all', this)">å…¨éƒ¨</button>
        <button class="filter-tab" onclick="setOutcomeFilter('win', this)">èµ¢</button>
        <button class="filter-tab" onclick="setOutcomeFilter('lose', this)">è¾“</button>
      </div>
    </div>
    <div id="recordsList"></div>
  </div>

</div>

<!-- é¢„ç®—å¼¹çª— -->
<div class="modal-overlay" id="budgetModal">
  <div class="modal">
    <h3 id="modalTitle">è®¾ç½®äºæŸä¸Šé™</h3>
    <p id="modalDesc">è¶…è¿‡ä¸Šé™å°±å‡ºç°çº¢è‰²è­¦å‘Šï¼Œæé†’çˆ¸å¦ˆæ”¶æ‰‹ï¼</p>
    <div class="modal-grid">
      <div class="form-group">
        <label>ğŸš ä¸€ç²’ç±³ï¼ˆå…ƒï¼‰</label>
        <input type="number" id="bDad" placeholder="ä¾‹ï¼š300" min="0">
      </div>
      <div class="form-group">
        <label>ğŸ‘©â€ğŸ« è°­è€å¸ˆï¼ˆå…ƒï¼‰</label>
        <input type="number" id="bMom" placeholder="ä¾‹ï¼š300" min="0">
      </div>
    </div>
    <div class="form-group">
      <label>åˆè®¡ä¸Šé™ï¼ˆå…ƒï¼‰â€” é€‰å¡«ï¼Œæ€»è§ˆæ¨¡å¼ä¸‹ä½¿ç”¨</label>
      <input type="number" id="bTotal" placeholder="ä¾‹ï¼š500" min="0">
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeBudgetModal()">å–æ¶ˆ</button>
      <button class="btn-confirm" onclick="saveBudget()">ä¿å­˜</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const NAMES = { dad: 'ä¸€ç²’ç±³', mom: 'è°­è€å¸ˆ' };
  let records = JSON.parse(localStorage.getItem('mj_records') || '[]');
  let budgets = JSON.parse(localStorage.getItem('mj_budgets') || '{"month":{},"week":{}}');

  let curPlayer = 'dad';
  let curOutcome = 'win';
  let viewPlayer = 'all';
  let outcomeFilter = 'all';
  let editBudgetType = 'month';

  document.getElementById('inputDate').value = new Date().toISOString().slice(0,10);

  /* Selectors */
  function selectPlayer(p) {
    curPlayer = p;
    document.getElementById('btnDad').className = 'toggle-btn' + (p==='dad' ? ' active-dad' : '');
    document.getElementById('btnMom').className = 'toggle-btn' + (p==='mom' ? ' active-mom' : '');
  }

  function selectOutcome(o) {
    curOutcome = o;
    document.getElementById('btnWin').className  = 'toggle-btn' + (o==='win'  ? ' active-win'  : '');
    document.getElementById('btnLose').className = 'toggle-btn' + (o==='lose' ? ' active-lose' : '');
  }

  function setViewPlayer(p, el) {
    viewPlayer = p;
    document.querySelectorAll('.player-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    renderAll();
  }

  function setOutcomeFilter(f, el) {
    outcomeFilter = f;
    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    renderRecords();
  }

  /* Add */
  function addRecord() {
    const date   = document.getElementById('inputDate').value;
    const amount = parseFloat(document.getElementById('inputAmount').value);
    const note   = document.getElementById('inputNote').value.trim();
    if (!date)            { showToast('ğŸ“… æ—¥æœŸä¸èƒ½ä¸ºç©ºå“¦'); return; }
    if (!amount || amount <= 0) { showToast('ğŸ’° é‡‘é¢å¾—å¡«ä¸ªæ­£æ•°å§'); return; }

    records.unshift({
      id: Date.now(), date, amount,
      player: curPlayer, outcome: curOutcome,
      note: note || (curOutcome === 'win'
        ? `${NAMES[curPlayer]}åˆèµ¢äº†ï¼`
        : `${NAMES[curPlayer]}ä»Šå¤©æ‰‹æ°”ä¸å¥½â€¦`)
    });

    localStorage.setItem('mj_records', JSON.stringify(records));
    document.getElementById('inputAmount').value = '';
    document.getElementById('inputNote').value = '';

    const msgs = curOutcome === 'win'
      ? ['è®°ä¸‹äº†ï¼è´¢ç¥çˆ·ä¿ä½‘ ğŸ‰', 'èµ¢äº†ï¼å¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´ âœ…', 'äººæŒ¡æ€äººï¼Œç‰ŒæŒ¡æ€ç‰Œ ğŸ€„']
      : ['å“ï¼Œè®°ä¸‹äº†â€¦ä¸‹æŠŠæ‰³å›æ¥ ğŸ™', 'äºäº†ä¹Ÿæ˜¯å†ç»ƒï¼Œè´¦è¦è®°æ¸…æ¥š ğŸ“', 'åˆ«ç°å¿ƒï¼Œä¸œé£è¿˜æ²¡æ¥ ğŸ’ª'];
    showToast(msgs[Math.floor(Math.random() * msgs.length)]);
    renderAll();
  }

  function deleteRecord(id) {
    if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ')) return;
    records = records.filter(r => r.id !== id);
    localStorage.setItem('mj_records', JSON.stringify(records));
    renderAll();
    showToast('ğŸ—‘ï¸ å·²åˆ é™¤');
  }

  /* Helpers */
  function getWeekBounds() {
    const now = new Date(), day = now.getDay() || 7;
    const mon = new Date(now); mon.setDate(now.getDate() - day + 1); mon.setHours(0,0,0,0);
    const sun = new Date(mon); sun.setDate(mon.getDate() + 6); sun.setHours(23,59,59,999);
    return [mon, sun];
  }

  function inThisMonth(d) {
    const n = new Date();
    return d.startsWith(`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}`);
  }

  function inThisWeek(d) {
    const [mon, sun] = getWeekBounds(), dt = new Date(d);
    return dt >= mon && dt <= sun;
  }

  function byPlayer(recs) { return viewPlayer === 'all' ? recs : recs.filter(r => r.player === viewPlayer); }
  function net(recs)  { return recs.reduce((s,r) => s + (r.outcome==='win' ? r.amount : -r.amount), 0); }
  function lossSum(recs) { return recs.filter(r => r.outcome==='lose').reduce((s,r) => s+r.amount, 0); }

  /* Stats */
  function renderStats() {
    const base     = byPlayer(records);
    const monthR   = base.filter(r => inThisMonth(r.date));
    const weekR    = base.filter(r => inThisWeek(r.date));
    const monthWin = monthR.filter(r => r.outcome==='win').length;

    const mNet = net(monthR), tNet = net(base), wNet = net(weekR);

    function setVal(id, val) {
      const el = document.getElementById(id);
      el.textContent = (val>=0?'+':'') + 'Â¥' + Math.abs(val);
      el.className = 'stat-value ' + (val>0?'win':val<0?'lose':'neutral');
    }

    setVal('monthNet', mNet);
    setVal('totalNet', tNet);
    setVal('weekNet', wNet);

    document.getElementById('monthSub').textContent   = mNet>0?'å°èµšä¸€ç¬” ğŸ˜„':mNet<0?'äºäº†ï¼ŒåŠ æ²¹ ğŸ’ª':'ä¸è¾“ä¸èµ¢';
    document.getElementById('monthCount').textContent = monthR.length;
    document.getElementById('monthWinRate').textContent = monthR.length ? `èƒœç‡ ${Math.round(monthWin/monthR.length*100)}%` : 'å¿«å»æ‰“ä¸€å±€';
    document.getElementById('totalSub').textContent   = `å…± ${base.length} åœº`;
    document.getElementById('weekSub').textContent    = `æœ¬å‘¨ ${weekR.length} åœº`;

    const pfx = viewPlayer==='all' ? '' : NAMES[viewPlayer]+' Â· ';
    document.getElementById('labelMonthNet').textContent = pfx + 'æœ¬æœˆå‡€æ”¶ç›Š';
    document.getElementById('labelWeekNet').textContent  = pfx + 'æœ¬å‘¨å‡€æ”¶ç›Š';
  }

  /* Budget bars */
  function renderBudget(type) {
    const b       = budgets[type] || {};
    const checker = type==='month' ? inThisMonth : inThisWeek;
    const period  = type==='month' ? 'æœ¬æœˆ' : 'æœ¬å‘¨';
    const fillEl  = document.getElementById(type==='month' ? 'monthFill' : 'weekFill');
    const statEl  = document.getElementById(type==='month' ? 'monthStatus' : 'weekStatus');

    const periodRecs = records.filter(r => checker(r.date));
    let limit = 0, lossVal = 0;

    if (viewPlayer === 'all') {
      limit   = b.total || 0;
      lossVal = lossSum(periodRecs);
    } else {
      limit   = b[viewPlayer] || 0;
      lossVal = lossSum(periodRecs.filter(r => r.player === viewPlayer));
    }

    if (!limit) {
      fillEl.style.width = '0%';
      fillEl.className = 'progress-fill';
      statEl.textContent = `ç‚¹ã€Œä¿®æ”¹ä¸Šé™ã€è®¾ç½®${period}æœ€å¤§äºæŸä¸Šé™ ğŸ™`;
      statEl.style.color = 'rgba(255,255,255,0.55)';
      return;
    }

    const pct = Math.min(lossVal / limit * 100, 100);
    fillEl.style.width = pct + '%';
    fillEl.className = 'progress-fill' + (pct>=100?' danger':pct>=70?' warning':'');

    const who = viewPlayer==='all' ? 'åˆè®¡' : NAMES[viewPlayer];
    if (pct >= 100) {
      statEl.innerHTML = `ğŸš¨ ${period}ã€${who}ã€‘å·²äº Â¥${lossVal}ï¼Œè¶…è¿‡ä¸Šé™ Â¥${limit}ï¼æ”¶æ‰‹å§ï¼`;
      statEl.style.color = '#ff6b6b';
    } else if (pct >= 70) {
      statEl.innerHTML = `âš ï¸ ${period}ã€${who}ã€‘å·²äº Â¥${lossVal} / Â¥${limit}ï¼ˆ${Math.round(pct)}%ï¼‰ï¼Œæ‚ ç€ç‚¹å“¦`;
      statEl.style.color = '#ffc107';
    } else {
      statEl.innerHTML = `âœ… ${period}ã€${who}ã€‘äºæŸ Â¥${lossVal} / Â¥${limit}ï¼ˆ${Math.round(pct)}%ï¼‰ï¼Œè¿˜å¥½è¿˜å¥½`;
      statEl.style.color = 'rgba(255,255,255,0.6)';
    }
  }

  /* Records list */
  function renderRecords() {
    const list = document.getElementById('recordsList');
    let recs = byPlayer(records);
    if (outcomeFilter !== 'all') recs = recs.filter(r => r.outcome === outcomeFilter);

    if (!recs.length) {
      list.innerHTML = `<div class="empty-state"><div class="icon">ğŸ€„</div><div>æš‚æ— è®°å½•<br>å¿«å»æ‰“ä¸€å±€ï¼</div></div>`;
      return;
    }

    list.innerHTML = recs.map(r => {
      const win = r.outcome === 'win';
      const tag = r.player==='dad'
        ? `<span class="player-tag tag-dad">ğŸš ä¸€ç²’ç±³</span>`
        : `<span class="player-tag tag-mom">ğŸ‘©â€ğŸ« è°­è€å¸ˆ</span>`;
      return `<div class="record-item">
        <div class="record-icon">${win ? 'ğŸ†' : 'ğŸ’¸'}</div>
        <div class="record-info">
          <div class="record-meta">
            <span class="record-date">${r.date.slice(5).replace('-','/')}</span>${tag}
          </div>
          <div class="record-note">${r.note.replace(/&/g,'&amp;').replace(/</g,'&lt;')}</div>
        </div>
        <div class="record-amount ${win?'win':'lose'}">${win?'+':'-'}Â¥${r.amount}</div>
        <button class="record-delete" onclick="deleteRecord(${r.id})">âœ•</button>
      </div>`;
    }).join('');
  }

  /* Budget modal */
  function openBudgetModal(type) {
    editBudgetType = type;
    const b = budgets[type] || {};
    document.getElementById('modalTitle').textContent = type==='month' ? 'ğŸ“… è®¾ç½®æ¯æœˆäºæŸä¸Šé™' : 'ğŸ—“ï¸ è®¾ç½®æ¯å‘¨äºæŸä¸Šé™';
    document.getElementById('modalDesc').textContent  = type==='month'
      ? 'æ¯æœˆäºæŸè¶…è¿‡ä¸Šé™ï¼Œå°±å‡ºç°çº¢è‰²è­¦å‘Šæé†’çˆ¸å¦ˆæ”¶æ‰‹ï¼'
      : 'æ¯å‘¨äºæŸè¶…è¿‡ä¸Šé™ï¼Œå°±å‡ºç°çº¢è‰²è­¦å‘Šæé†’çˆ¸å¦ˆæ”¶æ‰‹ï¼';
    document.getElementById('bDad').value   = b.dad   || '';
    document.getElementById('bMom').value   = b.mom   || '';
    document.getElementById('bTotal').value = b.total || '';
    document.getElementById('budgetModal').classList.add('show');
  }

  function closeBudgetModal() { document.getElementById('budgetModal').classList.remove('show'); }

  function saveBudget() {
    const dad   = parseInt(document.getElementById('bDad').value)   || 0;
    const mom   = parseInt(document.getElementById('bMom').value)   || 0;
    const total = parseInt(document.getElementById('bTotal').value) || 0;
    if (!dad && !mom && !total) { showToast('è‡³å°‘å¡«ä¸€ä¸ªä¸Šé™é‡‘é¢'); return; }
    budgets[editBudgetType] = { dad, mom, total };
    localStorage.setItem('mj_budgets', JSON.stringify(budgets));
    closeBudgetModal();
    renderBudget(editBudgetType);
    showToast(`âœ… ${editBudgetType==='month'?'æ¯æœˆ':'æ¯å‘¨'}ä¸Šé™å·²ä¿å­˜`);
  }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
  }

  document.getElementById('budgetModal').addEventListener('click', e => { if (e.target.id==='budgetModal') closeBudgetModal(); });

  function renderAll() { renderStats(); renderBudget('month'); renderBudget('week'); renderRecords(); }

  renderAll();
</script>
</body>
</html>
